<div id="dataviz_container2">
  <div class="text-container ui text container">
    <h3 class="text__header">
      An examination of the Clinicaltrials.gov data
    </h3>
    <p>
      
    </p>
  </div>
  <div class="text-container ui text container">
    <h3 class="text__header">
      Total Number of trials each year.
    </h3>
  </div>
  <div id="d3_linegraph_trials">
  </div> 
  <div id="d3_linegraph_trials_filter">
    <b>Species Filter:</b>
    <br>
    <br>
    <input name='linegraph_trials_v' value="digestive" type="checkbox" checked>Digestive
    </input>
    <br>
    <input name="linegraph_trials_v" value="cancer" type="checkbox" checked >Cancer
    </input>
    <br>
    <input name="linegraph_trials_v" value="immune" type="checkbox" checked >Immune
    </input>
    <br>
    <input name="linegraph_trials_v" value="wound" type="checkbox" checked >Wounds
    </input>
    <br>
    <input name="linegraph_trials_v" value="behvariour" type="checkbox" checked >Behaviour
    </input>
  </div>
  <div id="d3_linegraph_trials_slider-range">
  </div>
  <hr>
  <div class="text-container ui text container">
    <h3 class="text__header">
      Average enrollment per trial.
    </h3>
  </div>
  <div id="d3_linegraph_rateofchange">
  </div> 
  <div id="d3_linegraph_rateofchange_filter">
    <b>Species Filter:</b>
    <br>
    <br>
    <input name='linegraph_rateofchange_v' value="digestive" type="checkbox" checked>Digestive
    </input>
    <br>
    <input name="linegraph_rateofchange_v" value="cancer" type="checkbox" checked >Cancer
    </input>
    <br>
    <input name="linegraph_rateofchange_v" value="immune" type="checkbox" checked >Immune
    </input>
    <br>
    <input name="linegraph_rateofchange_v" value="wound" type="checkbox" checked >Wounds
    </input>
    <br>
    <input name="linegraph_rateofchange_v" value="beahviour" type="checkbox" checked >Behaviour
    </input>
  </div>
  <div id="d3_linegraph_rateofchange_slider-range">
  </div>
  <hr>
  <div class="text-container ui text container">
    <h3 class="text__header">
      Stacked rate of change over time
    </h3>
  </div>
  <div id="d3_stacked_area_chart">
  </div>
  <div id="d3_stacked_area_chart_slider-range">
  </div> 
  <div class="text-container ui text container">
    <h4>Key findings</h4>
    <ol>
      <li>Test 1</li>
      <li>Test 1</li>
      <li>Test 1</li>
      <li>Test 1</li>
      <li>Test 1</li>
    </ol>
  </div>
  <hr>
  <div class="text-container ui text container">
    <h3 class="text__header">
      Count of trial duration in months.
    </h3>
  </div>
  <div id="d3_scatterplot_duration">
  </div> 
  <div id="d3_scatterplot_duration_filter">
    <b>Species Filter:</b>
    <br>
    <br>
    <input name='v' value="digestive" type="checkbox" checked>Digestive
    </input>
    <br>
    <input name="v" value="cancer" type="checkbox" checked >Cancer
    </input>
    <br>
    <input name="v" value="immune" type="checkbox" checked >Immune
    </input>
    <br>
    <input name="v" value="wound" type="checkbox" checked >Wounds
    </input>
    <br>
    <input name="v" value="beahviour" type="checkbox" checked >Behaviour
    </input>
  </div>
  <div id="d3_scatterplot_duration_slider-range">
  </div>
  <hr>
  <div class="text-container ui text container">
    <h3 class="text__header">
      Count of subjects enrolled in trials
    </h3>
  </div>
  <div id="d3_scatterplot_enrollment">
  </div>
  <div id="d3_scatterplot_enrollment_filter">
    <b>Species Filter:</b>
    <br>
    <input name='dur_v' value="digestive" type="checkbox" checked>Digestive
    </input>
    <br>
    <input name="dur_v" value="cancer" type="checkbox" checked >Cancer
    </input>
    <br>
    <input name="dur_v" value="immune" type="checkbox" checked >Immune
    </input>
    <br>
    <input name="dur_v" value="wounds" type="checkbox" checked >Wounds
    </input>
    <br>
    <input name="dur_v" value="behaviour" type="checkbox" checked >Behaviour
    </input>
  </div>
  <div id="d3_scatterplot_enrollment_slider-range">
  </div>
</div>

<script type="text/javascript">
  var stacked_area_chart = function stacked_area_chart(data, org_data_copy) {
    console.log("stacked area chart called");

    var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    console.log("here1");

    var formatPercent = d3.format(".0%");
    var legendRectSize = 25;                                  // NEW
    var legendSpacing = 10;                                    // NEW
    var x = d3.time.scale().range([0, width]);
    var y = d3.scale.linear().range([height, 0]);

    var color = d3.scale.category20();

    console.log("here2");

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(formatPercent);

    console.log("here3");

    var area = d3.svg.area()
        .x(function(d) { return x(d.date); })
        .y0(function(d) { return y(d.y0); })
        .y1(function(d) { return y(d.y0 + d.y); });

    console.log("here4");

    var stack = d3.layout.stack()
        .values(function(d) { return d.values; });

    var svg = d3.select("#d3_stacked_area_chart").append("svg")        
                .attr('viewBox','0 0 1100 500')
                .attr('preserveAspectRatio','xMinYMin')
                .append("g")
                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    console.log("here5");

    var dataset = [
      { label: 'immune', count: 9399 },
      { label: 'Digestive', count: 18928 }, 
      { label: 'cancer', count: 15686 },
      { label: 'wound', count: 10496 },
      { label: 'behvaiour', count: 9021 }
    ];

    color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

    var browsers = stack(color.domain().map(function(name) {
      return {
        name: name,
        values: data.map(function(d) {
          return {date: d.date, y: d[name] / 100};
        })
      };
    }));

    x.domain(d3.extent(data, function(d) { return d.date; }));
    
    console.log("here7");

    var browser = svg.selectAll(".browser")
        .data(browsers)
      .enter().append("g")
        .attr("class", "browser");

    browser.append("path")
        .attr("class", "area")
        .attr("d", function(d) { return area(d.values); })
        .attr("transform", "translate(5 , -5)")
        .style("fill", function(d) { return color(d.name); });

    svg.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y-axis")
        .call(yAxis);

    var legend = svg.selectAll('.legend')                     // NEW
      .data(color.domain())                                   // NEW
      .enter()                                                // NEW
      .append('g')                                            // NEW
      .attr('class', 'legend')                                // NEW
      .attr('transform', function(d, i) {                     // NEW
        var height = legendRectSize + legendSpacing;          // NEW
        var offset =  height * color.domain().length / 2;     // NEW
        var horz = -2 * legendRectSize + 970;                       // NEW
        var vert = i * height - offset + 90;                       // NEW
        return 'translate(' + horz + ',' + vert + ')';        // NEW
      });                                                     // NEW

    legend.append('rect')                                     // NEW
      .attr('width', legendRectSize)                          // NEW
      .attr('height', legendRectSize)                         // NEW
      .style('fill', color)                                   // NEW
      .style('stroke', color);                                // NEW
      
    legend.append('text')                                     // NEW
      .attr('x', legendRectSize + legendSpacing)              // NEW
      .attr('y', legendRectSize - legendSpacing)              // NEW
      .text(function(d) { return d; });                       // NEW
  
    function zoom(begin, end) {

      var date1 = new Date();
      date1.setFullYear(1995 + begin,0,1);
      var date2 = new Date();
      date2.setFullYear(2015 + end - 20,0,1);

      console.log(date2);
      
      data = org_data_copy.filter(function(d) {
        return d.date > date1 && d.date < date2;
      });

      x.domain(d3.extent(data, function(d) { return d.date; }));
      svg.selectAll(".browser").remove();
      svg.selectAll(".x-axis").remove();

      var browsers = stack(color.domain().map(function(name) {
        return {
          name: name,
          values: data.map(function(d) {
              return {date: d.date, y: d[name] / 100};
          })
        };
      }));


      var browser = svg.selectAll(".browser")
          .data(browsers)
        .enter().append("g")
          .attr("class", "browser");


      browser.append("path")
          .attr("class", "area")
          .attr("d", function(d) { 
            return area(d.values); 
          })
          .attr("transform", "translate(5 , -5)")
          .style("fill", function(d) { return color(d.name); })
          .transition()
          .duration(2000);

      svg.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
    }

    $(function() {
      $( "#d3_stacked_area_chart_slider-range" ).slider({
        range: true,
        min: 0,
        max: 20,
        values: [0, 20],
        slide: function( event, ui ) {
          var begin = d3.min([ui.values[0]]);
          var end = d3.max([ui.values[1]]);
          console.log("begin:", begin, "end:", end);

          zoom(begin, end);
        }
      });
    });
  };
  var p = new Promise(function(resolve, reject) {      
    // Do an async task async task and then...
    if(resolve) {
      var data = [];
      var parseDate = d3.time.format("%Y").parse,
          formatPercent = d3.format(".0%");
      d3.csv("https://s3-us-west-2.amazonaws.com/dotaempower/dataviz/data2.csv", function(error, csvdata) {
        if (error) throw error;
        data = csvdata;
        console.log(data);

        data.forEach(function(d) {
          d.date = parseDate(d.date);
        });
        resolve(data);
      });
    }
    else {
      reject('Failure!');
    }
  });
  p.then(function(response) { 
    /* do something with the result */
    var data = response;
    var org_data_copy = response;
    var formatPercent = d3.format(".0%");
    stacked_area_chart(data, org_data_copy);
  }).catch(function() {
    /* error :( */
  })
</script>
<script>
  var scatterplot_duration = function scatterplot_duration(src, container, slider) {

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      
    var x = d3.scale.linear()
        .range([0, width]);

    var y = d3.scale.linear()
        .range([height, 0]);


    var color = d3.scale.category10();

    // var axisNames = { 
    //                     petalWidth: 'Petal Width', 
    //                     petalLength: 'Petal Length', 
    //                     sepalWidth: 'Sepal Width', 
    //                     sepalLength: 'Sepal Length' 
    //                 };

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")
        .innerTickSize(-height)
        .outerTickSize(0)
        .tickPadding(5)
        .ticks(10);

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .innerTickSize(-width)
        .outerTickSize(0)
        .tickPadding(5)
        .ticks(10);


    var scatterplot_duration_svg = d3.select(container).append("svg")
        .attr('viewBox','-50 0 1000 520')
        .attr('preserveAspectRatio','xMinYMin')
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    d3.csv(src, function(error, data) {
      org_data_copy2 = data;

      console.log(error);
      console.log(data);
      data.forEach(function(d) {
        d.enrollment = +d.month;
        d.count = +d.count;
        d.type = d.type;
      });

      x.domain(d3.extent(data, function(d) { return d.enrollment; })).nice();
      y.domain(d3.extent(data, function(d) { return d.count; })).nice();

      scatterplot_duration_svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width / 2 + 120)
          .attr("y", 50)
          .attr("font-size", "30px")
          .style("text-anchor", "end")
          .text("Number of months");

      scatterplot_duration_svg.append("g")
          .attr("class", "y-axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")  
          .attr("transform", "translate("+ (50/2) +","+(height/2 - 100)+")rotate(-90)") 
          .attr("y", -100)
          .attr("font-size", "30px")
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Number of trials")



     var circles = scatterplot_duration_svg.selectAll(".dot")
          .data(data)
        .enter().append("circle")
          .attr("class", "dot")
          .attr("r", 3.5)
          .attr("cx", function(d) { return x(d.enrollment); })
          .attr("cy", function(d) { return y(d.count); })
          .style("fill", function(d) { return color(d.type); });


      var legend = scatterplot_duration_svg.selectAll(".legend")
          .data(color.domain())
          .enter().append("g")
          .attr("class", "legend")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });


      legend.append("rect")
          .attr("x", width - 18)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", color);

      legend.append("text")
          .attr("x", width - 24)
          .attr("y", 9)
          .attr("dy", ".35em")
          .style("text-anchor", "end")
          .text(function(d) { return d; })
          .on("click", function(d) { alert("Hello world"); });



      d3.selectAll("[name=v]").on("change", function() {
          var selected = this.value;
          display = this.checked ? "inline" : "none";
          console.log(selected);
          scatterplot_duration_svg.selectAll(".dot")
              .filter(function(d) {return selected == d.type;})
              .attr("display", display);
          });

    });

    function duration_zoom(begin, end) {
      console.log("duration zoom");
      // console.log("begin is " + begin);
      // console.log("end is " + end);

      scatterplot_duration_svg.selectAll(".dot").remove();
      scatterplot_duration_svg.selectAll(".x-axis").remove();
      scatterplot_duration_svg.selectAll(".y-axis").remove();
      scatterplot_duration_svg.selectAll(".tick").remove();
      
      data = org_data_copy2.filter(function(d) {
        d.enrollment = +d.enrollment;
        return d.enrollment > begin && d.enrollment < end ;
      });

      // console.log("data is " + data.length);
      // console.log("org_data_copy is " + org_data_copy.length);

      data.forEach(function(d) {
        d.enrollment = +d.enrollment;
        d.count = +d.count;
        d.type = d.type;
      });

      x.domain(d3.extent(data, function(d) { return d.enrollment; })).nice();
      y.domain(d3.extent(data, function(d) { return d.count; })).nice();

      scatterplot_duration_svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width / 2 + 120)
          .attr("y", 50)
          .attr("font-size", "30px")
          .style("text-anchor", "end")
          .text("Number of months");

      scatterplot_duration_svg.append("g")
          .attr("class", "y-axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")  
          .attr("transform", "translate("+ (50/2) +","+(height/2 - 100)+")rotate(-90)") 
          .attr("y", -100)
          .attr("font-size", "30px")
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Number of trials")



     var circles = scatterplot_duration_svg.selectAll(".dot")
          .data(data)
        .enter().append("circle")
          .attr("class", "dot")
          .attr("r", 3.5)
          .attr("cx", function(d) { return x(d.enrollment); })
          .attr("cy", function(d) { return y(d.count); })
          .style("fill", function(d) { return color(d.type); });
    }

    $("#d3_scatterplot_duration_slider-range").slider({
        range: true,
        min: 0,
        max: 80,
        values: [0, 80],
        slide: function( event, ui ) {
          var begin = d3.min([ui.values[0]]);
          var end = d3.max([ui.values[1]]);
          console.log("begin:", begin, "end:", end);
          duration_zoom(begin, end);
        }
      });
  }
  scatterplot_duration("https://s3-us-west-2.amazonaws.com/dotaempower/dataviz/data_duration.csv","#d3_scatterplot_duration","#d3_scatterplot_duration_slider-range");
</script>
<script type="text/javascript">
  var scatterplot_enrollment = function scatterplot_enrollment(src, container, slider) {

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      
    var x = d3.scale.linear()
        .range([0, width]);

    var y = d3.scale.linear()
        .range([height, 0]);


    var color = d3.scale.category10();

    // var axisNames = { 
    //                     petalWidth: 'Petal Width', 
    //                     petalLength: 'Petal Length', 
    //                     sepalWidth: 'Sepal Width', 
    //                     sepalLength: 'Sepal Length' 
    //                 };

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")
        .innerTickSize(-height)
        .outerTickSize(0)
        .tickPadding(5)
        .ticks(10);

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .innerTickSize(-width)
        .outerTickSize(0)
        .tickPadding(5)
        .ticks(10);


    var svg = d3.select("#d3_scatterplot_enrollment").append("svg")
        .attr('viewBox','-50 0 1000 520')
        .attr('preserveAspectRatio','xMinYMin')
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    d3.csv(src, function(error, data) {
      org_data_copy = data;

      data.forEach(function(d) {
        d.enrollment = +d.enrollment;
        d.count = +d.count;
        d.type = d.type;
      });

      x.domain(d3.extent(data, function(d) { return d.enrollment; })).nice();
      y.domain(d3.extent(data, function(d) { return d.count; })).nice();

      svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width / 2 + 120)
          .attr("y", 50)
          .attr("font-size", "30px")
          .style("text-anchor", "end")
          .text("Number of subjects");

      svg.append("g")
          .attr("class", "y-axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")  
          .attr("transform", "translate("+ (50/2) +","+(height/2 - 100)+")rotate(-90)") 
          .attr("y", -100)
          .attr("font-size", "30px")
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Number of trials")



     var circles = svg.selectAll(".dot")
          .data(data)
        .enter().append("circle")
          .attr("class", "dot")
          .attr("r", 3.5)
          .attr("cx", function(d) { return x(d.enrollment); })
          .attr("cy", function(d) { return y(d.count); })
          .style("fill", function(d) { return color(d.type); });


      var legend = svg.selectAll(".legend")
          .data(color.domain())
          .enter().append("g")
          .attr("class", "legend")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });


      legend.append("rect")
          .attr("x", width - 18)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", color);

      legend.append("text")
          .attr("x", width - 24)
          .attr("y", 9)
          .attr("dy", ".35em")
          .style("text-anchor", "end")
          .text(function(d) { return d; })
          .on("click", function(d) { alert("Hello world"); });



      d3.selectAll("[name=dur_v]").on("change", function() {
          var selected = this.value;
          display = this.checked ? "inline" : "none";
          console.log(selected);
          svg.selectAll(".dot")
              .filter(function(d) {return selected == d.type;})
              .attr("display", display);
          });

    });
    
    function enrollment_zoom(begin, end) {

      console.log("enrollment zoom");

      svg.selectAll(".dot").remove();
      svg.selectAll(".x-axis").remove();
      svg.selectAll(".y-axis").remove();
      svg.selectAll(".tick").remove();
      
      data = org_data_copy.filter(function(d) {
        d.enrollment = +d.enrollment;
        return d.enrollment > begin && d.enrollment < end ;
      });

      data.forEach(function(d) {
        d.enrollment = +d.enrollment;
        d.count = +d.count;
        d.type = d.type;
      });

      x.domain(d3.extent(data, function(d) { return d.enrollment; })).nice();
      y.domain(d3.extent(data, function(d) { return d.count; })).nice();

      svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width / 2 + 120)
          .attr("y", 50)
          .attr("font-size", "30px")
          .style("text-anchor", "end")
          .text("Number of subjects");

      svg.append("g")
          .attr("class", "y-axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")  
          .attr("transform", "translate("+ (50/2) +","+(height/2 - 100)+")rotate(-90)") 
          .attr("y", -100)
          .attr("font-size", "30px")
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Number of trials")


     var circles = svg.selectAll(".dot")
          .data(data)
        .enter().append("circle")
          .attr("class", "dot")
          .attr("r", 3.5)
          .attr("cx", function(d) { return x(d.enrollment); })
          .attr("cy", function(d) { return y(d.count); })
          .style("fill", function(d) { return color(d.type); });
    }

    $("#d3_scatterplot_enrollment_slider-range").slider({
      range: true,
      min: 0,
      max: 45,
      values: [0, 45],
      slide: function( event, ui ) {
        var begin = d3.min([ui.values[0]]);
        var end = d3.max([ui.values[1]]);
        console.log("begin:", begin, "end:", end);

        enrollment_zoom(begin, end);
      }
    });
  }
  scatterplot_enrollment("https://s3-us-west-2.amazonaws.com/dotaempower/dataviz/data_enrollment.csv","#d3_scatterplot_enrollment","#d3_scatterplot_enrollment_slider-range");
</script>
<script type="text/javascript">
  var line_graph = function line_graph(){

    var margin = {top: 20, right: 80, bottom: 30, left: 50},
        width = 700 - margin.left - margin.right,
        height = 350 - margin.top - margin.bottom;

    var parseDate = d3.time.format("%Y").parse;

    var x = d3.time.scale()
        .range([0, width]);

    var y = d3.scale.linear()
        .range([height, 0]);

    var color = d3.scale.category10();

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

    var line = d3.svg.line()
        .interpolate("basis")
        .x(function(d) { return x(d.date); })
        .y(function(d) { return y(d.temperature); });

    var line_chart_trialnumber = d3.select("#d3_linegraph_trials").append("svg")
        .attr('viewBox','-50 0 800 400')
        .attr('preserveAspectRatio','xMinYMin')
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.csv("https://s3-us-west-2.amazonaws.com/dotaempower/dataviz/data.csv", function(error, data) {
      if (error) throw error;
      
      color.domain(d3.keys(data[0]).filter(function(key) { return key !== "year"; }));

      data.forEach(function(d) {
        d.date = parseDate(d.year);
        console.log(d.date);
      });
      org_data_copy_line_chart_trialnumber = data;

      var cities = color.domain().map(function(name) {
        return {
          name: name,
          values: data.map(function(d) {
            return {date: d.date, temperature: +d[name]};
          })
        };
      });

      x.domain(d3.extent(data, function(d) { return d.date; }));

      y.domain([
        d3.min(cities, function(c) { return d3.min(c.values, function(v) { return v.temperature; }); }),
        d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.temperature; }); })
      ]);

      console.log("y domain is " + y.domain());

      line_chart_trialnumber.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width / 2 + 120)
          .attr("y", 50)
          .attr("font-size", "24px")
          .style("text-anchor", "end")
          .text("Number of subjects");

      line_chart_trialnumber.append("g")
          .attr("class", "y-axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")  
          .attr("transform", "translate("+ (30/2) +","+(height/2 - 100)+")rotate(-90)") 
          .attr("y", -100)
          .attr("font-size", "24px")
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Number of trials");

      var city = line_chart_trialnumber.selectAll(".city")
                      .data(cities)
                    .enter().append("g")
                      .attr("class", "city");

      city.append("path")
          .attr("class", "line")
          .attr("d", function(d) { return line(d.values); })
          .style("stroke", function(d) { return color(d.name); })
          .transition()
          .duration(1000)
          .ease("linear");

      city.append("text")
          .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
          .attr("class","line_chart_trialnumber_label")
          .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")"; })
          .attr("x", 3)
          .attr("dy", ".35em")
          .text(function(d) { return d.name; });

      
      var colorsarr = ["behvariour","wound","immune","digestive"]


      var circles = line_chart_trialnumber.selectAll(".row")
          .data(data)
        .enter().append('g');



      circles.selectAll('.circle')
          .data(function(d, i) { 
            var array = $.map(data[i], function(value, index) {
                if (index!="year") return [value];
            }); 
            return array; 
          })
        .enter().append('circle')
          .attr("class", "path-circle")
          .attr('r', 2.5 )
          .attr('cx', function(d, i) { if (i!=5) return x(this.parentNode.__data__.date); })
          .attr('cy', function(d,i)  { if (i!=5) return y(d); })
          .attr("stroke", function (d,i) { 
            for(var key in this.parentNode.__data__) {
              if(this.parentNode.__data__[key] === d) {
                  return color(key);
              }
            }
          })
          .attr("fill","none");
      
      d3.selectAll("[name=linegraph_trials_v]").on("change", function() {
        var selected = this.value;
        display = this.checked ? "inline" : "none";
        // debugger; 
        console.log(selected);
        // debugger;
        // console.log(line_chart_trialnumber.selectAll(".city"));
        line_chart_trialnumber.selectAll("circle")
            .filter(function(d) {
              for(var key in this.parentNode.__data__) {
                if(this.parentNode.__data__[key] === d) {
                  return selected == key;
                }
              }
            })
            .attr("display", display);
        line_chart_trialnumber.selectAll("path")
            .filter(function(d) {
              return selected == d.name;
            })
            .attr("display", display);
        line_chart_trialnumber.selectAll(".line_chart_trialnumber_label")
            .filter(function(d) {
              return selected == d.name;
            })
            .attr("display", display);
      });

    });


    function leastSquares(xSeries, ySeries) {
      var reduceSumFunc = function(prev, cur) { return prev + cur; };
      
      var xBar = xSeries.reduce(reduceSumFunc) * 1.0 / xSeries.length;
      var yBar = ySeries.reduce(reduceSumFunc) * 1.0 / ySeries.length;

      var ssXX = xSeries.map(function(d) { return Math.pow(d - xBar, 2); })
        .reduce(reduceSumFunc);
      
      var ssYY = ySeries.map(function(d) { return Math.pow(d - yBar, 2); })
        .reduce(reduceSumFunc);
        
      var ssXY = xSeries.map(function(d, i) { return (d - xBar) * (ySeries[i] - yBar); })
        .reduce(reduceSumFunc);
        
      var slope = ssXY / ssXX;
      var intercept = yBar - (xBar * slope);
      var rSquare = Math.pow(ssXY, 2) / (ssXX * ssYY);
      
      return [slope, intercept, rSquare];
    }

    function line_chart_trialnumber_zoom (begin, end) {

      var date1 = new Date();
      date1.setFullYear(1995 + begin,0,1);
      var date2 = new Date();
      date2.setFullYear(2015 + end - 20,0,1);

      line_chart_trialnumber.selectAll("*").remove();
      // d3.selectAll(".x-axis").remove();
      // d3.selectAll(".y-axis").remove();
      // d3.selectAll(".y-axis").remove();
      // d3.selectAll(".city").remove();
      // d3.selectAll(".row").remove();
      // d3.selectAll(".path-circle").remove();
      // console.log(date2);
      console.log("zoom y domain is " + y.domain());
      
      data = org_data_copy_line_chart_trialnumber.filter(function(d) {
        return d.date >= date1 && d.date <= date2;
      });
      color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date" && key != "year"; }));
      x.domain(d3.extent(data, function(d) { return d.date; }));

      var cities = color.domain().map(function(name) {
        return {
          name: name,
          values: data.map(function(d) {
            return {date: d.date, temperature: +d[name]};
          })
        };
      });

      y.domain([
        d3.min(cities, function(c) { return d3.min(c.values, function(v) { return v.temperature; }); }),
        d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.temperature; }); })
      ]);

      console.log("y domain is " + y.domain());

      line_chart_trialnumber.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width / 2 + 120)
          .attr("y", 50)
          .attr("font-size", "24px")
          .style("text-anchor", "end")
          .text("Number of subjects");

      line_chart_trialnumber.append("g")
          .attr("class", "y-axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")  
          .attr("transform", "translate("+ (30/2) +","+(height/2 - 100)+")rotate(-90)") 
          .attr("y", -100)
          .attr("font-size", "24px")
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Number of trials");

      var city = line_chart_trialnumber.selectAll(".city")
                      .data(cities)
                    .enter().append("g")
                      .attr("class", "city");

      var path = city.append("path")
          // .transition()
          // .duration(1000)
          // .ease("linear")
          .attr("class", "line")
          .attr("d", function(d) { return line(d.values); })
          .style("stroke", function(d) { return color(d.name); });
          

      city.append("text")
          .attr("class","line_chart_trialnumber_label")
          .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
          .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")"; })
          .attr("x", 3)
          .attr("dy", ".35em")
          .text(function(d) { return d.name; });

      
      var colorsarr = ["behvariour","wound","immune","digestive"]


      var circles = line_chart_trialnumber.selectAll(".row")
          .data(data)
        .enter().append('g');
  

      circles.selectAll('.circle')
          .data(function(d, i) { 
            var array = $.map(data[i], function(value, index) {
                if (index!="year") return [value];
            }); 
            return array; 
          })
        .enter().append('circle')
          .attr("class", "path-circle")
          .attr('r', 2.5 )
          .attr('cx', function(d, i) { if (i!=5) return x(this.parentNode.__data__.date); })
          .attr('cy', function(d,i)  { if (i!=5) return y(d); })
          .attr("stroke", function (d,i) { 
            for(var key in this.parentNode.__data__) {
              if(this.parentNode.__data__[key] === d) {
                  return color(key);
              }
            }
          })
          .attr("fill","none");

    }

    $("#d3_linegraph_trials_slider-range").slider({
      range: true,
      min: 0,
      max: 20,
      values: [0, 20],
      slide: function( event, ui ) {
        var begin = d3.min([ui.values[0]]);
        var end = d3.max([ui.values[1]]);
        // console.log("begin:", begin, "end:", end);

        line_chart_trialnumber_zoom(begin, end);
      }
    });
  }
  line_graph();
</script>
<script type="text/javascript">
  var line_graph2 = function line_graph2(){

    var margin = {top: 20, right: 80, bottom: 30, left: 50},
        width = 700 - margin.left - margin.right,
        height = 350 - margin.top - margin.bottom;

    var formatnum = d3.format(".4g");

    var parseDate = d3.time.format("%Y").parse;

    var x = d3.time.scale()
        .range([0, width]);

    var y = d3.scale.linear()
        .range([height, 0]);

    var color = d3.scale.category10();

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

    var line = d3.svg.line()
        .interpolate("basis")
        .x(function(d) { return x(d.date); })
        .y(function(d) { return y(d.temperature); });

    var linegraph_enrollment = d3.select("#d3_linegraph_rateofchange").append("svg")
        .attr('viewBox','-50 0 800 400')
        .attr('preserveAspectRatio','xMinYMin')
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.csv("https://s3-us-west-2.amazonaws.com/dotaempower/dataviz/rateofchange.csv", function(error, data) {
      if (error) throw error;
      
      color.domain(d3.keys(data[0]).filter(function(key) { return key !== "year"; }));

      data.forEach(function(d) {
        for(var key in d) {
          if (key != "year") {
            d[key] = Math.round(d[key]);
          };
        }
        d.date = parseDate(d.year);
        console.log(d.date);
      });
      org_data_copy = data;

      var cities = color.domain().map(function(name) {
        return {
          name: name,
          values: data.map(function(d) {
            return {date: d.date, temperature: +d[name]};
          })
        };
      });

      x.domain(d3.extent(data, function(d) { return d.date; }));

      y.domain([
        d3.min(cities, function(c) { return d3.min(c.values, function(v) { return v.temperature; }); }),
        d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.temperature; }); })
      ]);

      console.log("y domain is " + y.domain());

      linegraph_enrollment.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width / 2 + 120)
          .attr("y", 50)
          .attr("font-size", "24px")
          .style("text-anchor", "end")
          .text("Number of subjects");

      linegraph_enrollment.append("g")
          .attr("class", "y-axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")  
          .attr("transform", "translate("+ (30/2) +","+(height/2 - 100)+")rotate(-90)") 
          .attr("y", -100)
          .attr("font-size", "24px")
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Number of trials");

      var city = linegraph_enrollment.selectAll(".city")
                      .data(cities)
                    .enter().append("g")
                      .attr("class", "city");

      city.append("path")
          .attr("class", "line")
          .attr("d", function(d) { return line(d.values); })
          .style("stroke", function(d) { return color(d.name); });

      // city.append("text")
      //     .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
      //     .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")"; })
      //     .attr("x", 3)
      //     .attr("dy", ".35em")
      //     .text(function(d) { return d.name; });

      
      var colorsarr = ["behvariour","wound","immune","digestive"]


      var circles = linegraph_enrollment.selectAll(".row")
          .data(data)
        .enter().append('g');
  

      circles.selectAll('.circle')
          .data(function(d, i) { 
            var array = $.map(data[i], function(value, index) {
                if (index!="year") return [value];
            }); 
            return array; 
          })
        .enter().append('circle')
          .attr("class", "path-circle")
          .attr('r', 2.5 )
          .attr('cx', function(d, i) { if (i!=5) return x(this.parentNode.__data__.date); })
          .attr('cy', function(d,i)  { if (i!=5) return y(d) + 2; })
          .attr("stroke", function (d,i) { 
            for(var key in this.parentNode.__data__) {
              if(this.parentNode.__data__[key] === d) {
                  return color(key);
              }
            }
          })
          .attr("fill","none");
    });
  
    function zoom (begin, end) {

      var date1 = new Date();
      date1.setFullYear(1995 + begin,0,1);
      var date2 = new Date();
      date2.setFullYear(2015 + end - 20,0,1);

      linegraph_enrollment.selectAll("*").remove();
      // d3.selectAll(".x-axis").remove();
      // d3.selectAll(".y-axis").remove();
      // d3.selectAll(".y-axis").remove();
      // d3.selectAll(".city").remove();
      // d3.selectAll(".row").remove();
      // d3.selectAll(".path-circle").remove();
      // console.log(date2);
      // console.log("zoom y domain is " + y.domain());
      
      data = org_data_copy.filter(function(d) {
        return d.date >= date1 && d.date <= date2;
      });
      color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date" && key != "year"; }));
      x.domain(d3.extent(data, function(d) { return d.date; }));

      var cities = color.domain().map(function(name) {
        return {
          name: name,
          values: data.map(function(d) {
            return {date: d.date, temperature: +d[name]};
          })
        };
      });

      y.domain([
        d3.min(cities, function(c) { return d3.min(c.values, function(v) { return v.temperature; }); }),
        d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.temperature; }); })
      ]);

      console.log("y domain is " + y.domain());

      linegraph_enrollment.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width / 2 + 120)
          .attr("y", 50)
          .attr("font-size", "24px")
          .style("text-anchor", "end")
          .text("Number of subjects");

      linegraph_enrollment.append("g")
          .attr("class", "y-axis")
          .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("text-anchor", "middle")  
          .attr("transform", "translate("+ (30/2) +","+(height/2 - 100)+")rotate(-90)") 
          .attr("y", -100)
          .attr("font-size", "24px")
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Number of trials");

      var city = linegraph_enrollment.selectAll(".city")
                      .data(cities)
                    .enter().append("g")
                      .attr("class", "city");

      city.append("path")
          .attr("class", "line")
          .attr("d", function(d) { return line(d.values); })
          .style("stroke", function(d) { return color(d.name); });

      // city.append("text")
      //     .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
      //     .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")"; })
      //     .attr("x", 3)
      //     .attr("dy", ".35em")
      //     .text(function(d) { return d.name; });

      
      var colorsarr = ["behvariour","wound","immune","digestive"]


      var circles = linegraph_enrollment.selectAll(".row")
          .data(data)
        .enter().append('g');
  

      circles.selectAll('.circle')
          .data(function(d, i) { 
            var array = $.map(data[i], function(value, index) {
                if (index!="year") return [value];
            }); 
            return array; 
          })
        .enter().append('circle')
          .attr("class", "path-circle")
          .attr('r', 2.5 )
          .attr('cx', function(d, i) { if (i!=5) return x(this.parentNode.__data__.date); })
          .attr('cy', function(d,i)  { if (i!=5) return y(d); })
          .attr("stroke", function (d,i) { 
            for(var key in this.parentNode.__data__) {
              if(this.parentNode.__data__[key] === d) {
                  return color(key);
              }
            }
          })
          .attr("fill","none");

    }

    $("#d3_linegraph_rateofchange_slider-range").slider({
      range: true,
      min: 0,
      max: 20,
      values: [0, 20],
      slide: function( event, ui ) {
        var begin = d3.min([ui.values[0]]);
        var end = d3.max([ui.values[1]]);
        // console.log("begin:", begin, "end:", end);

        zoom(begin, end);
      }
    });
  }
  line_graph2();
</script>
